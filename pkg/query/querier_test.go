// Copyright (c) The Thanos Authors.
// Licensed under the Apache License 2.0.

package query

import (
	"context"
	"fmt"
	"io/ioutil"
	"math"
	"math/rand"
	"os"
	"reflect"
	"sort"
	"strconv"
	"testing"
	"time"

	"github.com/fortytw2/leaktest"
	"github.com/go-kit/kit/log"
	"github.com/pkg/errors"
	"github.com/prometheus/prometheus/pkg/labels"
	"github.com/prometheus/prometheus/pkg/timestamp"
	"github.com/prometheus/prometheus/pkg/value"
	"github.com/prometheus/prometheus/promql"
	"github.com/prometheus/prometheus/storage"
	"github.com/prometheus/prometheus/tsdb/chunkenc"
	"github.com/thanos-io/thanos/pkg/component"
	"github.com/thanos-io/thanos/pkg/store"
	"github.com/thanos-io/thanos/pkg/store/storepb"
	"github.com/thanos-io/thanos/pkg/testutil"
)

func TestQueryableCreator_MaxResolution(t *testing.T) {
	defer leaktest.CheckTimeout(t, 10*time.Second)()
	testProxy := &storeServer{resps: []*storepb.SeriesResponse{}}
	queryableCreator := NewQueryableCreator(nil, testProxy)

	oneHourMillis := int64(1*time.Hour) / int64(time.Millisecond)
	queryable := queryableCreator(false, nil, oneHourMillis, false, false)

	q, err := queryable.Querier(context.Background(), 0, 42)
	testutil.Ok(t, err)
	defer func() { testutil.Ok(t, q.Close()) }()

	querierActual, ok := q.(*querier)

	testutil.Assert(t, ok == true, "expected it to be a querier")
	testutil.Assert(t, querierActual.maxResolutionMillis == oneHourMillis, "expected max source resolution to be 1 hour in milliseconds")

}

// Tests E2E how PromQL works with downsampled data.
func TestQuerier_DownsampledData(t *testing.T) {
	defer leaktest.CheckTimeout(t, 10*time.Second)()
	testProxy := &storeServer{
		resps: []*storepb.SeriesResponse{
			storeSeriesResponse(t, labels.FromStrings("__name__", "a", "zzz", "a", "aaa", "bbb"), []sample{{99, 1}, {199, 5}}),                   // Downsampled chunk from Store.
			storeSeriesResponse(t, labels.FromStrings("__name__", "a", "zzz", "b", "bbbb", "eee"), []sample{{99, 3}, {199, 8}}),                  // Downsampled chunk from Store.
			storeSeriesResponse(t, labels.FromStrings("__name__", "a", "zzz", "c", "qwe", "wqeqw"), []sample{{99, 5}, {199, 15}}),                // Downsampled chunk from Store.
			storeSeriesResponse(t, labels.FromStrings("__name__", "a", "zzz", "c", "htgtreytr", "vbnbv"), []sample{{99, 123}, {199, 15}}),        // Downsampled chunk from Store.
			storeSeriesResponse(t, labels.FromStrings("__name__", "a", "zzz", "d", "asdsad", "qweqwewq"), []sample{{22, 5}, {44, 8}, {199, 15}}), // Raw chunk from Sidecar.
			storeSeriesResponse(t, labels.FromStrings("__name__", "a", "zzz", "d", "asdsad", "qweqwebb"), []sample{{22, 5}, {44, 8}, {199, 15}}), // Raw chunk from Sidecar.
		},
	}

	q := NewQueryableCreator(nil, testProxy)(false, nil, 9999999, false, false)

	engine := promql.NewEngine(
		promql.EngineOpts{
			MaxConcurrent: 10,
			MaxSamples:    math.MaxInt32,
			Timeout:       10 * time.Second,
		},
	)

	// Minimal function to parse time.Time.
	ptm := func(in string) time.Time {
		fl, _ := strconv.ParseFloat(in, 64)
		s, ns := math.Modf(fl)
		return time.Unix(int64(s), int64(ns*float64(time.Second)))
	}

	st := ptm("0")
	ed := ptm("0.2")
	qry, err := engine.NewRangeQuery(
		q,
		"sum(a) by (zzz)",
		st,
		ed,
		100*time.Millisecond,
	)
	testutil.Ok(t, err)

	res := qry.Exec(context.Background())
	testutil.Ok(t, res.Err)
	m, err := res.Matrix()
	testutil.Ok(t, err)
	ser := []promql.Series(m)

	testutil.Assert(t, len(ser) == 4, "should return 4 series (got %d)", len(ser))

	exp := []promql.Series{
		{
			Metric: labels.FromStrings("zzz", "a"),
			Points: []promql.Point{
				{
					T: 100,
					V: 1,
				},
				{
					T: 200,
					V: 5,
				},
			},
		},
		{
			Metric: labels.FromStrings("zzz", "b"),
			Points: []promql.Point{
				{
					T: 100,
					V: 3,
				},
				{
					T: 200,
					V: 8,
				},
			},
		},
		{
			Metric: labels.FromStrings("zzz", "c"),
			// Test case: downsampling code adds all of the samples in the
			// 5 minute window of each series and pre-aggregates the data. However,
			// Prometheus engine code only takes the latest sample in each time window of
			// the retrieved data. Since we were operating in pre-aggregated data here, it lead
			// to overinflated values.
			Points: []promql.Point{
				{
					T: 100,
					V: 128,
				},
				{
					T: 200,
					V: 30,
				},
			},
		},
		{
			Metric: labels.FromStrings("zzz", "d"),
			// Test case: Prometheus engine in each time window selects the sample
			// which is closest to the boundaries and adds up the different dimensions.
			Points: []promql.Point{
				{
					T: 100,
					V: 16,
				},
				{
					T: 200,
					V: 30,
				},
			},
		},
	}

	if !reflect.DeepEqual(ser, exp) {
		t.Fatalf("response does not match, expected:\n%+v\ngot:\n%+v", exp, ser)
	}
}

var (
	expectedRealSeriesReplica0 = []sample{
		{t: 1582329611249, v: 3.395395e+06}, {t: 1582329626245, v: 3.39592e+06}, {t: 1582329641245, v: 3.396402e+06}, {t: 1582329656245, v: 3.396882e+06}, {t: 1582329671245, v: 3.397394e+06}, {t: 1582329686245, v: 3.397804e+06},
		{t: 1582329701245, v: 3.398296e+06}, {t: 1582329716245, v: 3.398878e+06}, {t: 1582329731245, v: 3.399373e+06}, {t: 1582329746245, v: 3.39992e+06}, {t: 1582329761245, v: 3.400436e+06}, {t: 1582329776245, v: 3.400974e+06},
		{t: 1582329791245, v: 3.401408e+06}, {t: 1582329806245, v: 3.401901e+06}, {t: 1582329821245, v: 3.402411e+06}, {t: 1582329836245, v: 3.402944e+06}, {t: 1582329851245, v: 3.403404e+06}, {t: 1582329866245, v: 3.403735e+06},
		{t: 1582329881245, v: 3.404301e+06}, {t: 1582329896245, v: 3.404818e+06}, {t: 1582329911245, v: 3.405327e+06}, {t: 1582329926245, v: 3.405843e+06}, {t: 1582329941245, v: 3.406297e+06}, {t: 1582329956245, v: 3.406737e+06},
		{t: 1582329971245, v: 3.407212e+06}, {t: 1582329986245, v: 3.407647e+06}, {t: 1582330001245, v: 3.407929e+06}, {t: 1582330016245, v: 3.408614e+06}, {t: 1582330031245, v: 3.409217e+06}, {t: 1582330046245, v: 3.409658e+06},
		{t: 1582330061245, v: 3.410276e+06}, {t: 1582330076245, v: 3.410795e+06}, {t: 1582330091245, v: 3.411509e+06}, {t: 1582330106245, v: 3.411974e+06}, {t: 1582330121245, v: 3.412368e+06}, {t: 1582330136245, v: 3.412863e+06},
		{t: 1582330151245, v: 3.413412e+06}, {t: 1582330166245, v: 3.413783e+06}, {t: 1582330181245, v: 3.41424e+06}, {t: 1582330196245, v: 3.414634e+06}, {t: 1582330211245, v: 3.415246e+06}, {t: 1582330226245, v: 3.415615e+06},
		{t: 1582330241245, v: 3.416287e+06}, {t: 1582330256245, v: 3.416753e+06}, {t: 1582330271245, v: 3.417229e+06}, {t: 1582330286245, v: 3.417748e+06}, {t: 1582330301245, v: 3.418185e+06}, {t: 1582330316245, v: 3.418707e+06},
		{t: 1582330331245, v: 3.419142e+06}, {t: 1582330346245, v: 3.419595e+06}, {t: 1582330361245, v: 3.420042e+06}, {t: 1582330376245, v: 3.420544e+06}, {t: 1582330391245, v: 3.420926e+06}, {t: 1582330406245, v: 3.421447e+06},
		{t: 1582330421245, v: 3.421899e+06}, {t: 1582330436245, v: 3.422238e+06}, {t: 1582330451245, v: 3.422619e+06}, {t: 1582330466245, v: 3.422958e+06}, {t: 1582330481251, v: 3.423455e+06}, {t: 1582330496245, v: 3.423991e+06},
		{t: 1582330511245, v: 3.424478e+06}, {t: 1582330526245, v: 3.425018e+06}, {t: 1582330541245, v: 3.425455e+06}, {t: 1582330556245, v: 3.42597e+06}, {t: 1582330571245, v: 3.426343e+06}, {t: 1582330586245, v: 3.426881e+06},
		{t: 1582330601245, v: 3.427435e+06}, {t: 1582330616245, v: 3.42803e+06}, {t: 1582330631261, v: 3.42861e+06}, {t: 1582330646245, v: 3.429152e+06}, {t: 1582330661245, v: 3.429711e+06}, {t: 1582330676245, v: 3.430061e+06},
		{t: 1582330691245, v: 3.430594e+06}, {t: 1582330706245, v: 3.431031e+06}, {t: 1582330721245, v: 3.431528e+06}, {t: 1582330736245, v: 3.432125e+06}, {t: 1582330751245, v: 3.432611e+06}, {t: 1582330766245, v: 3.433042e+06},
		{t: 1582330781245, v: 3.433544e+06}, {t: 1582330796245, v: 3.434109e+06}, {t: 1582330811245, v: 3.434386e+06}, {t: 1582330826245, v: 3.434891e+06}, {t: 1582330841245, v: 3.43544e+06}, {t: 1582330856245, v: 3.435977e+06},
		{t: 1582330871245, v: 3.436528e+06}, {t: 1582330886245, v: 3.437145e+06}, {t: 1582330901245, v: 3.437773e+06}, {t: 1582330916245, v: 3.438278e+06}, {t: 1582330931245, v: 3.438664e+06}, {t: 1582330946245, v: 3.439135e+06},
		{t: 1582330961245, v: 3.439635e+06}, {t: 1582330976245, v: 3.440136e+06}, {t: 1582330991245, v: 3.440572e+06}, {t: 1582331006245, v: 3.441014e+06}, {t: 1582331021256, v: 3.441373e+06}, {t: 1582331036245, v: 3.441745e+06},
		{t: 1582331051245, v: 3.442336e+06}, {t: 1582331066245, v: 3.44291e+06}, {t: 1582331081245, v: 3.443478e+06}, {t: 1582331096245, v: 3.443938e+06}, {t: 1582331111245, v: 3.444436e+06}, {t: 1582331126245, v: 3.445027e+06},
		{t: 1582331141245, v: 3.445382e+06}, {t: 1582331156245, v: 3.445853e+06}, {t: 1582331171262, v: 3.446356e+06}, {t: 1582331186245, v: 3.446899e+06}, {t: 1582331201245, v: 3.44743e+06}, {t: 1582331216245, v: 3.448002e+06},
		{t: 1582331231245, v: 3.448451e+06}, {t: 1582331246245, v: 3.448974e+06}, {t: 1582331261259, v: 3.449337e+06}, {t: 1582331276245, v: 3.449841e+06}, {t: 1582331291245, v: 3.450478e+06}, {t: 1582331306245, v: 3.450903e+06},
		{t: 1582331321245, v: 3.451404e+06}, {t: 1582331336245, v: 3.451778e+06}, {t: 1582331351245, v: 3.452278e+06}, {t: 1582331366245, v: 3.452711e+06}, {t: 1582331381245, v: 3.453142e+06},
	}
	expectedRealSeriesReplica1 = []sample{
		{t: 1582329618053, v: 3.395638e+06}, {t: 1582329633053, v: 3.396163e+06}, {t: 1582329648053, v: 3.396612e+06}, {t: 1582329663053, v: 3.397174e+06}, {t: 1582329678053, v: 3.397564e+06}, {t: 1582329693053, v: 3.398039e+06},
		{t: 1582329708053, v: 3.39847e+06}, {t: 1582329723053, v: 3.399088e+06}, {t: 1582329738053, v: 3.399668e+06}, {t: 1582329753053, v: 3.400198e+06}, {t: 1582329768053, v: 3.400705e+06}, {t: 1582329783053, v: 3.401209e+06},
		{t: 1582329798053, v: 3.401606e+06}, {t: 1582329813053, v: 3.402171e+06}, {t: 1582329828054, v: 3.402601e+06}, {t: 1582329843053, v: 3.403164e+06}, {t: 1582329858053, v: 3.40357e+06}, {t: 1582329873053, v: 3.404005e+06},
		{t: 1582329888053, v: 3.404553e+06}, {t: 1582329903053, v: 3.405076e+06}, {t: 1582329918053, v: 3.40554e+06}, {t: 1582329933053, v: 3.406012e+06}, {t: 1582329948053, v: 3.406466e+06}, {t: 1582329963053, v: 3.407003e+06},
		{t: 1582329978053, v: 3.407378e+06}, {t: 1582329993053, v: 3.407728e+06}, {t: 1582330008053, v: 3.40835e+06}, {t: 1582330023053, v: 3.408935e+06}, {t: 1582330038053, v: 3.409436e+06}, {t: 1582330053053, v: 3.409904e+06},
		{t: 1582330068053, v: 3.410449e+06}, {t: 1582330083053, v: 3.411078e+06}, {t: 1582330098053, v: 3.411737e+06}, {t: 1582330113053, v: 3.41214e+06}, {t: 1582330128053, v: 3.412598e+06}, {t: 1582330143053, v: 3.413069e+06},
		{t: 1582330158053, v: 3.4136e+06}, {t: 1582330173053, v: 3.413985e+06}, {t: 1582330188053, v: 3.414443e+06}, {t: 1582330203053, v: 3.414959e+06}, {t: 1582330218053, v: 3.415411e+06}, {t: 1582330233053, v: 3.415962e+06},
		{t: 1582330248064, v: 3.416517e+06}, {t: 1582330263053, v: 3.416999e+06}, {t: 1582330278053, v: 3.417466e+06}, {t: 1582330293053, v: 3.418001e+06}, {t: 1582330308053, v: 3.418434e+06}, {t: 1582330323053, v: 3.41892e+06},
		{t: 1582330338053, v: 3.419327e+06}, {t: 1582330353053, v: 3.419814e+06}, {t: 1582330368053, v: 3.420281e+06}, {t: 1582330383053, v: 3.420671e+06}, {t: 1582330398053, v: 3.421132e+06}, {t: 1582330413058, v: 3.421673e+06},
		{t: 1582330428053, v: 3.42204e+06}, {t: 1582330443053, v: 3.422405e+06}, {t: 1582330458053, v: 3.422753e+06}, {t: 1582330473053, v: 3.423144e+06}, {t: 1582330488067, v: 3.423663e+06}, {t: 1582330503053, v: 3.424217e+06},
		{t: 1582330518053, v: 3.424743e+06}, {t: 1582330533053, v: 3.425246e+06}, {t: 1582330548053, v: 3.425641e+06}, {t: 1582330563054, v: 3.426142e+06}, {t: 1582330578053, v: 3.426571e+06}, {t: 1582330593053, v: 3.427067e+06},
		{t: 1582330608053, v: 3.427776e+06}, {t: 1582330623053, v: 3.428342e+06}, {t: 1582330638053, v: 3.428903e+06}, {t: 1582330653077, v: 3.429352e+06}, {t: 1582330668053, v: 3.429892e+06}, {t: 1582330683053, v: 3.430238e+06},
		{t: 1582330698053, v: 3.430812e+06}, {t: 1582330713053, v: 3.431257e+06}, {t: 1582330728056, v: 3.431899e+06}, {t: 1582330743053, v: 3.432422e+06}, {t: 1582330758053, v: 3.432863e+06}, {t: 1582330773053, v: 3.433215e+06},
		{t: 1582330788053, v: 3.433822e+06}, {t: 1582330803053, v: 3.434217e+06}, {t: 1582330818053, v: 3.434559e+06}, {t: 1582330833053, v: 3.43516e+06}, {t: 1582330848053, v: 3.435718e+06}, {t: 1582330863053, v: 3.436289e+06},
		{t: 1582330878053, v: 3.436776e+06}, {t: 1582330893053, v: 3.437315e+06}, {t: 1582330908053, v: 3.437971e+06}, {t: 1582330923053, v: 3.438459e+06}, {t: 1582330938053, v: 3.438912e+06}, {t: 1582330953053, v: 3.439307e+06},
		{t: 1582330968053, v: 3.439861e+06}, {t: 1582330983053, v: 3.440302e+06}, {t: 1582330998053, v: 3.440744e+06}, {t: 1582331013053, v: 3.441185e+06}, {t: 1582331028053, v: 3.441574e+06}, {t: 1582331043053, v: 3.442031e+06},
		{t: 1582331058053, v: 3.442613e+06}, {t: 1582331073053, v: 3.443145e+06}, {t: 1582331088053, v: 3.443649e+06}, {t: 1582331103053, v: 3.444181e+06}, {t: 1582331118053, v: 3.444643e+06}, {t: 1582331133053, v: 3.445203e+06},
		{t: 1582331148053, v: 3.445629e+06}, {t: 1582331163053, v: 3.446097e+06}, {t: 1582331178053, v: 3.446645e+06}, {t: 1582331193053, v: 3.447223e+06}, {t: 1582331208054, v: 3.447765e+06}, {t: 1582331223053, v: 3.448241e+06},
		{t: 1582331238053, v: 3.448659e+06}, {t: 1582331253053, v: 3.449075e+06}, {t: 1582331268053, v: 3.449566e+06}, {t: 1582331283053, v: 3.450086e+06}, {t: 1582331298053, v: 3.450673e+06}, {t: 1582331313053, v: 3.451119e+06},
		{t: 1582331328053, v: 3.451611e+06}, {t: 1582331343053, v: 3.452079e+06}, {t: 1582331358053, v: 3.452434e+06}, {t: 1582331373053, v: 3.452943e+06},
	}
	expectedRealSeriesWithStaleMarkerReplica0 = []sample{
		{t: 1587690007139, v: 461993}, {t: 1587690022139, v: 462164}, {t: 1587690037139, v: 462409}, {t: 1587690052139, v: 462662}, {t: 1587690067139, v: 462824}, {t: 1587690082139, v: 462987}, {t: 1587690097155, v: 463108}, {t: 1587690112139, v: 463261}, {t: 1587690127139, v: 463465}, {t: 1587690142139, v: 463642},
		{t: 1587690157139, v: 463823}, {t: 1587690172139, v: 464065}, {t: 1587690187139, v: 464333}, {t: 1587690202139, v: 464566}, {t: 1587690217139, v: 464811}, {t: 1587690232140, v: 465032}, {t: 1587690247139, v: 465229}, {t: 1587690262139, v: 465445}, {t: 1587690277139, v: 465700}, {t: 1587690292139, v: 465884},
		{t: 1587690307139, v: 466083}, {t: 1587690322139, v: 466250}, {t: 1587690337150, v: 466534}, {t: 1587690352139, v: 466791}, {t: 1587690367139, v: 466970}, {t: 1587690382139, v: 467149}, {t: 1587690397139, v: 467265}, {t: 1587690412139, v: 467383}, {t: 1587690427139, v: 467647}, {t: 1587690442139, v: 467943},
		{t: 1587690457139, v: 468121}, {t: 1587690472139, v: 468294}, {t: 1587690487139, v: 468545}, {t: 1587690502139, v: 468676}, {t: 1587690517139, v: 468879}, {t: 1587690532139, v: 469154}, {t: 1587690547139, v: 469281}, {t: 1587690562139, v: 469512}, {t: 1587690577139, v: 469783}, {t: 1587690592139, v: 469964},
		{t: 1587690607139, v: 470171}, {t: 1587690622139, v: 470355}, {t: 1587690637139, v: 470656}, {t: 1587690652139, v: 470845}, {t: 1587690667139, v: 471077}, {t: 1587690682139, v: 471315}, {t: 1587690697139, v: 471535}, {t: 1587690712139, v: 471766}, {t: 1587690727139, v: 472002}, {t: 1587690742139, v: 472171},
		{t: 1587690757139, v: 472354}, {t: 1587690772139, v: 472736}, {t: 1587690787139, v: 472948}, {t: 1587690802139, v: 473259}, {t: 1587690817139, v: 473460}, {t: 1587690832139, v: 473753}, {t: 1587690847139, v: 474007}, {t: 1587690862139, v: 474286}, {t: 1587690877139, v: 474423}, {t: 1587690892139, v: 474788},
		{t: 1587690907139, v: 474925}, {t: 1587690922139, v: 475031}, {t: 1587690937139, v: 475316}, {t: 1587690952139, v: 475573}, {t: 1587690967139, v: 475784}, {t: 1587690982139, v: 475992}, {t: 1587690997139, v: 476341}, {t: 1587691012139, v: 476541}, {t: 1587691027139, v: 476890}, {t: 1587691042139, v: 477033},
		{t: 1587691057139, v: 477305}, {t: 1587691072139, v: 477577}, {t: 1587691087139, v: 477771}, {t: 1587691102139, v: 478012}, {t: 1587691117139, v: 478296}, {t: 1587691132139, v: 478559}, {t: 1587691147139, v: 478744}, {t: 1587691162139, v: 478950}, {t: 1587691177139, v: 479201}, {t: 1587691192139, v: 479388},
		{t: 1587691207139, v: 479638}, {t: 1587691222154, v: 479907}, {t: 1587691237139, v: 480008}, {t: 1587691252139, v: 480167}, {t: 1587691267139, v: 480472}, {t: 1587691282157, v: 480615}, {t: 1587691297139, v: 480771}, {t: 1587691312139, v: 481027}, {t: 1587691327139, v: 481212}, {t: 1587691342159, v: 481395},
		{t: 1587691357139, v: 481598}, {t: 1587691372139, v: 481786}, {t: 1587691387139, v: 482003}, {t: 1587691402141, v: 482236}, {t: 1587691417139, v: 482508}, {t: 1587691432139, v: 482636}, {t: 1587691447139, v: 482780}, {t: 1587691462139, v: 483059}, {t: 1587691477139, v: 483357}, {t: 1587691492139, v: 483566},
		{t: 1587691507139, v: 483711}, {t: 1587691522139, v: 483838}, {t: 1587691537139, v: 484091}, {t: 1587691552139, v: 484254}, {t: 1587691567139, v: 484479}, {t: 1587691582139, v: 484748}, {t: 1587691597139, v: 484978}, {t: 1587691612139, v: 485271}, {t: 1587691627139, v: 485488}, {t: 1587691642139, v: 485700},
		{t: 1587691657139, v: 485945}, {t: 1587691672139, v: 486228}, {t: 1587691687139, v: 486588}, {t: 1587691702139, v: 486691}, {t: 1587691717139, v: 486881}, {t: 1587691732139, v: 487046}, {t: 1587691747139, v: 487291}, {t: 1587691762177, v: 487410}, {t: 1587691777139, v: 487571}, {t: 1587691792139, v: 487799},
		{t: 1587691807139, v: 488050}, {t: 1587691822139, v: 488241}, {t: 1587691837139, v: 488424}, {t: 1587691852139, v: 488629}, {t: 1587691867139, v: 488875}, {t: 1587691882139, v: 489017}, {t: 1587691897139, v: 489254}, {t: 1587691912139, v: 489545}, {t: 1587691927139, v: 489778}, {t: 1587691942139, v: 489912},
		{t: 1587691957139, v: 490084}, {t: 1587691972139, v: 490364}, {t: 1587691987139, v: 490510}, {t: 1587692002139, v: 490744}, {t: 1587692017139, v: 490880}, {t: 1587692032139, v: 491025}, {t: 1587692047139, v: 491297}, {t: 1587692062155, v: 491557}, {t: 1587692077139, v: 491839}, {t: 1587692092139, v: 492065},
		{t: 1587692107139, v: 492234}, {t: 1587692122139, v: 492526}, {t: 1587692137139, v: 492767}, {t: 1587692152139, v: 492967}, {t: 1587692167139, v: 493218}, {t: 1587692182139, v: 493442}, {t: 1587692197139, v: 493647}, {t: 1587692212139, v: 493920}, {t: 1587692227139, v: 494170}, {t: 1587692242139, v: 494358},
		{t: 1587692257139, v: 494632}, {t: 1587692272139, v: 494800}, {t: 1587692287139, v: 495026}, {t: 1587692302139, v: 495222}, {t: 1587692317139, v: 495433}, {t: 1587692332139, v: 495677}, {t: 1587692347139, v: 495901}, {t: 1587692362139, v: 496107}, {t: 1587692377139, v: 496196}, {t: 1587692392139, v: 496245},
		{t: 1587692407139, v: 496300}, {t: 1587692422159, v: 496365}, {t: 1587692437139, v: 496401}, {t: 1587692452139, v: 496452}, {t: 1587692467139, v: 496532}, {t: 1587692482139, v: math.Float64frombits(value.StaleNaN)}, {t: 1587692542149, v: 5}, {t: 1587692557139, v: 101}, {t: 1587692572139, v: 312}, {t: 1587692587139, v: 508},
		{t: 1587692602144, v: 725}, {t: 1587692617139, v: 990}, {t: 1587692632139, v: 1178}, {t: 1587692647139, v: 1406}, {t: 1587692662154, v: 1640}, {t: 1587692677139, v: 1927}, {t: 1587692692139, v: 2103}, {t: 1587692707139, v: 2300}, {t: 1587692722139, v: 2482}, {t: 1587692737139, v: 2638}, {t: 1587692752139, v: 2806},
		{t: 1587692767139, v: 2979}, {t: 1587692782149, v: 3187}, {t: 1587692797139, v: 3441}, {t: 1587692812139, v: 3657}, {t: 1587692827139, v: 3827}, {t: 1587692842139, v: 3985}, {t: 1587692857139, v: 4195}, {t: 1587692872139, v: 4427}, {t: 1587692887139, v: 4646}, {t: 1587692902139, v: 4714}, {t: 1587692917153, v: 4872},
		{t: 1587692932139, v: 5131}, {t: 1587692947139, v: 5318}, {t: 1587692962139, v: 5571}, {t: 1587692977155, v: 5748}, {t: 1587692992139, v: 6030}, {t: 1587693007139, v: 6210}, {t: 1587693022139, v: 6399}, {t: 1587693037139, v: 6658}, {t: 1587693052139, v: 6896}, {t: 1587693067139, v: 7098}, {t: 1587693082139, v: 7341},
		{t: 1587693097139, v: 7495}, {t: 1587693112139, v: 7647}, {t: 1587693127139, v: 7830}, {t: 1587693142139, v: 8058}, {t: 1587693157139, v: 8209}, {t: 1587693172139, v: 8524}, {t: 1587693187139, v: 8712}, {t: 1587693202139, v: 8904}, {t: 1587693217139, v: 9103}, {t: 1587693232139, v: 9404}, {t: 1587693247155, v: 9556},
		{t: 1587693262139, v: 9777}, {t: 1587693277139, v: 9992}, {t: 1587693292139, v: 10268}, {t: 1587693307139, v: 10478}, {t: 1587693322139, v: 10754}, {t: 1587693337139, v: 10998}, {t: 1587693352139, v: 11249}, {t: 1587693367139, v: 11459}, {t: 1587693382139, v: 11778}, {t: 1587693397139, v: 12038},
		{t: 1587693412139, v: 12238}, {t: 1587693427139, v: 12450}, {t: 1587693442163, v: 12742}, {t: 1587693457139, v: 12945}, {t: 1587693472139, v: 13181}, {t: 1587693487139, v: 13440}, {t: 1587693502139, v: 13650}, {t: 1587693517139, v: 13966}, {t: 1587693532139, v: 14122}, {t: 1587693547139, v: 14327}, {t: 1587693562139, v: 14592},
		{t: 1587693577139, v: 14782}, {t: 1587693592139, v: 14956},
	}
	expectedRealSeriesWithStaleMarkerReplica1 = []sample{
		{t: 1587690005791, v: 461968}, {t: 1587690020791, v: 462151}, {t: 1587690035797, v: 462336}, {t: 1587690050791, v: 462650}, {t: 1587690065791, v: 462813}, {t: 1587690080791, v: 462987}, {t: 1587690095791, v: 463095}, {t: 1587690110791, v: 463247}, {t: 1587690125791, v: 463440}, {t: 1587690140791, v: 463642}, {t: 1587690155791, v: 463811},
		{t: 1587690170791, v: 464027}, {t: 1587690185791, v: 464308}, {t: 1587690200791, v: 464514}, {t: 1587690215791, v: 464798}, {t: 1587690230791, v: 465018}, {t: 1587690245791, v: 465215}, {t: 1587690260813, v: 465431}, {t: 1587690275791, v: 465651}, {t: 1587690290791, v: 465870}, {t: 1587690305791, v: 466070}, {t: 1587690320792, v: 466248},
		{t: 1587690335791, v: 466506}, {t: 1587690350791, v: 466766}, {t: 1587690365791, v: 466970}, {t: 1587690380791, v: 467123}, {t: 1587690395791, v: 467265}, {t: 1587690410791, v: 467383}, {t: 1587690425791, v: 467629}, {t: 1587690440791, v: 467931}, {t: 1587690455791, v: 468097}, {t: 1587690470791, v: 468281}, {t: 1587690485791, v: 468477},
		{t: 1587690500791, v: 468649}, {t: 1587690515791, v: 468867}, {t: 1587690530791, v: 469150}, {t: 1587690545791, v: 469268}, {t: 1587690560791, v: 469488}, {t: 1587690575791, v: 469742}, {t: 1587690590791, v: 469951}, {t: 1587690605791, v: 470131}, {t: 1587690620791, v: 470337}, {t: 1587690635791, v: 470631}, {t: 1587690650791, v: 470832},
		{t: 1587690665791, v: 471077}, {t: 1587690680791, v: 471311}, {t: 1587690695791, v: 471473}, {t: 1587690710791, v: 471728}, {t: 1587690725791, v: 472002}, {t: 1587690740791, v: 472158}, {t: 1587690755791, v: 472329}, {t: 1587690770791, v: 472722}, {t: 1587690785791, v: 472925}, {t: 1587690800791, v: 473220}, {t: 1587690815791, v: 473460},
		{t: 1587690830791, v: 473748}, {t: 1587690845791, v: 473968}, {t: 1587690860791, v: 474261}, {t: 1587690875791, v: 474418}, {t: 1587690890791, v: 474726}, {t: 1587690905791, v: 474913}, {t: 1587690920791, v: 475031}, {t: 1587690935791, v: 475284}, {t: 1587690950791, v: 475563}, {t: 1587690965791, v: 475762}, {t: 1587690980791, v: 475945},
		{t: 1587690995791, v: 476302}, {t: 1587691010791, v: 476501}, {t: 1587691025791, v: 476849}, {t: 1587691040800, v: 477020}, {t: 1587691055791, v: 477280}, {t: 1587691070791, v: 477549}, {t: 1587691085791, v: 477758}, {t: 1587691100817, v: 477960}, {t: 1587691115791, v: 478261}, {t: 1587691130791, v: 478559}, {t: 1587691145791, v: 478704},
		{t: 1587691160804, v: 478950}, {t: 1587691175791, v: 479173}, {t: 1587691190791, v: 479368}, {t: 1587691205791, v: 479625}, {t: 1587691220805, v: 479866}, {t: 1587691235791, v: 480008}, {t: 1587691250791, v: 480155}, {t: 1587691265791, v: 480472}, {t: 1587691280811, v: 480598}, {t: 1587691295791, v: 480771}, {t: 1587691310791, v: 480996},
		{t: 1587691325791, v: 481200}, {t: 1587691340803, v: 481381}, {t: 1587691355791, v: 481584}, {t: 1587691370791, v: 481759}, {t: 1587691385791, v: 482003}, {t: 1587691400803, v: 482189}, {t: 1587691415791, v: 482457}, {t: 1587691430791, v: 482623}, {t: 1587691445791, v: 482768}, {t: 1587691460804, v: 483036}, {t: 1587691475791, v: 483322},
		{t: 1587691490791, v: 483566}, {t: 1587691505791, v: 483709}, {t: 1587691520807, v: 483838}, {t: 1587691535791, v: 484091}, {t: 1587691550791, v: 484236}, {t: 1587691565791, v: 484454}, {t: 1587691580816, v: 484710}, {t: 1587691595791, v: 484978}, {t: 1587691610791, v: 485271}, {t: 1587691625791, v: 485476}, {t: 1587691640792, v: 485640},
		{t: 1587691655791, v: 485921}, {t: 1587691670791, v: 486201}, {t: 1587691685791, v: 486555}, {t: 1587691700791, v: 486691}, {t: 1587691715791, v: 486831}, {t: 1587691730791, v: 487033}, {t: 1587691745791, v: 487268}, {t: 1587691760803, v: 487370}, {t: 1587691775791, v: 487571}, {t: 1587691790791, v: 487787}, {t: 1587691805791, v: 488036},
		{t: 1587691820791, v: 488241}, {t: 1587691835791, v: 488411}, {t: 1587691850791, v: 488625}, {t: 1587691865791, v: 488868}, {t: 1587691880791, v: 489005}, {t: 1587691895791, v: 489237}, {t: 1587691910791, v: 489545}, {t: 1587691925791, v: 489750}, {t: 1587691940791, v: 489899}, {t: 1587691955791, v: 490048}, {t: 1587691970791, v: 490364},
		{t: 1587691985791, v: 490485}, {t: 1587692000791, v: 490722}, {t: 1587692015791, v: 490866}, {t: 1587692030791, v: 491025}, {t: 1587692045791, v: 491286}, {t: 1587692060816, v: 491543}, {t: 1587692075791, v: 491787}, {t: 1587692090791, v: 492065}, {t: 1587692105791, v: 492223}, {t: 1587692120816, v: 492501}, {t: 1587692135791, v: 492767},
		{t: 1587692150791, v: 492955}, {t: 1587692165791, v: 493194}, {t: 1587692180792, v: 493402}, {t: 1587692195791, v: 493647}, {t: 1587692210791, v: 493897}, {t: 1587692225791, v: 494117}, {t: 1587692240805, v: 494356}, {t: 1587692255791, v: 494620}, {t: 1587692270791, v: 494762}, {t: 1587692285791, v: 495001}, {t: 1587692300805, v: 495222},
		{t: 1587692315791, v: 495393}, {t: 1587692330791, v: 495662}, {t: 1587692345791, v: 495875}, {t: 1587692360801, v: 496082}, {t: 1587692375791, v: 496196}, {t: 1587692390791, v: 496245}, {t: 1587692405791, v: 496295}, {t: 1587692420791, v: 496365}, {t: 1587692435791, v: 496401}, {t: 1587692450791, v: 496452}, {t: 1587692465791, v: 496491},
		{t: 1587692480791, v: 496544}, {t: 1587692495791, v: math.Float64frombits(value.StaleNaN)}, {t: 1587692555791, v: 75}, {t: 1587692570791, v: 308}, {t: 1587692585791, v: 508}, {t: 1587692600791, v: 701}, {t: 1587692615791, v: 985}, {t: 1587692630791, v: 1153}, {t: 1587692645791, v: 1365}, {t: 1587692660791, v: 1612}, {t: 1587692675803, v: 1922}, {t: 1587692690791, v: 2103},
		{t: 1587692705791, v: 2261}, {t: 1587692720791, v: 2469}, {t: 1587692735805, v: 2625}, {t: 1587692750791, v: 2801}, {t: 1587692765791, v: 2955}, {t: 1587692780791, v: 3187}, {t: 1587692795806, v: 3428}, {t: 1587692810791, v: 3657}, {t: 1587692825791, v: 3810}, {t: 1587692840791, v: 3968}, {t: 1587692855791, v: 4195}, {t: 1587692870791, v: 4414},
		{t: 1587692885791, v: 4646}, {t: 1587692900791, v: 4689}, {t: 1587692915791, v: 4847}, {t: 1587692930791, v: 5105}, {t: 1587692945791, v: 5309}, {t: 1587692960791, v: 5521}, {t: 1587692975791, v: 5695}, {t: 1587692990810, v: 6010}, {t: 1587693005791, v: 6210}, {t: 1587693020791, v: 6394}, {t: 1587693035791, v: 6597}, {t: 1587693050791, v: 6872},
		{t: 1587693065791, v: 7098}, {t: 1587693080791, v: 7329}, {t: 1587693095791, v: 7470}, {t: 1587693110791, v: 7634}, {t: 1587693125821, v: 7830}, {t: 1587693140791, v: 8034}, {t: 1587693155791, v: 8209}, {t: 1587693170791, v: 8499}, {t: 1587693185791, v: 8688}, {t: 1587693200791, v: 8893}, {t: 1587693215791, v: 9052}, {t: 1587693230791, v: 9379},
		{t: 1587693245791, v: 9544}, {t: 1587693260791, v: 9763}, {t: 1587693275791, v: 9974}, {t: 1587693290791, v: 10242}, {t: 1587693305791, v: 10464}, {t: 1587693320803, v: 10716}, {t: 1587693335791, v: 10975}, {t: 1587693350791, v: 11232}, {t: 1587693365791, v: 11459}, {t: 1587693380791, v: 11778}, {t: 1587693395804, v: 12007}, {t: 1587693410791, v: 12206},
		{t: 1587693425791, v: 12450}, {t: 1587693440791, v: 12693}, {t: 1587693455791, v: 12908}, {t: 1587693470791, v: 13158}, {t: 1587693485791, v: 13427}, {t: 1587693500791, v: 13603}, {t: 1587693515791, v: 13927}, {t: 1587693530816, v: 14122}, {t: 1587693545791, v: 14327}, {t: 1587693560791, v: 14579}, {t: 1587693575791, v: 14759}, {t: 1587693590791, v: 14956},
	}

	expectedRealSeriesWithStaleMarkerDeduplicated = []sample{
		{t: 1587690005791, v: 461968}, {t: 1587690020791, v: 462151}, {t: 1587690035797, v: 462336}, {t: 1587690050791, v: 462650}, {t: 1587690065791, v: 462813}, {t: 1587690080791, v: 462987}, {t: 1587690095791, v: 463095}, {t: 1587690110791, v: 463247}, {t: 1587690125791, v: 463440}, {t: 1587690140791, v: 463642}, {t: 1587690155791, v: 463811},
		{t: 1587690170791, v: 464027}, {t: 1587690185791, v: 464308}, {t: 1587690200791, v: 464514}, {t: 1587690215791, v: 464798}, {t: 1587690230791, v: 465018}, {t: 1587690245791, v: 465215}, {t: 1587690260813, v: 465431}, {t: 1587690275791, v: 465651}, {t: 1587690290791, v: 465870}, {t: 1587690305791, v: 466070}, {t: 1587690320792, v: 466248},
		{t: 1587690335791, v: 466506}, {t: 1587690350791, v: 466766}, {t: 1587690365791, v: 466970}, {t: 1587690380791, v: 467123}, {t: 1587690395791, v: 467265}, {t: 1587690410791, v: 467383}, {t: 1587690425791, v: 467629}, {t: 1587690440791, v: 467931}, {t: 1587690455791, v: 468097}, {t: 1587690470791, v: 468281}, {t: 1587690485791, v: 468477},
		{t: 1587690500791, v: 468649}, {t: 1587690515791, v: 468867}, {t: 1587690530791, v: 469150}, {t: 1587690545791, v: 469268}, {t: 1587690560791, v: 469488}, {t: 1587690575791, v: 469742}, {t: 1587690590791, v: 469951}, {t: 1587690605791, v: 470131}, {t: 1587690620791, v: 470337}, {t: 1587690635791, v: 470631}, {t: 1587690650791, v: 470832},
		{t: 1587690665791, v: 471077}, {t: 1587690680791, v: 471311}, {t: 1587690695791, v: 471473}, {t: 1587690710791, v: 471728}, {t: 1587690725791, v: 472002}, {t: 1587690740791, v: 472158}, {t: 1587690755791, v: 472329}, {t: 1587690770791, v: 472722}, {t: 1587690785791, v: 472925}, {t: 1587690800791, v: 473220}, {t: 1587690815791, v: 473460},
		{t: 1587690830791, v: 473748}, {t: 1587690845791, v: 473968}, {t: 1587690860791, v: 474261}, {t: 1587690875791, v: 474418}, {t: 1587690890791, v: 474726}, {t: 1587690905791, v: 474913}, {t: 1587690920791, v: 475031}, {t: 1587690935791, v: 475284}, {t: 1587690950791, v: 475563}, {t: 1587690965791, v: 475762}, {t: 1587690980791, v: 475945},
		{t: 1587690995791, v: 476302}, {t: 1587691010791, v: 476501}, {t: 1587691025791, v: 476849}, {t: 1587691040800, v: 477020}, {t: 1587691055791, v: 477280}, {t: 1587691070791, v: 477549}, {t: 1587691085791, v: 477758}, {t: 1587691100817, v: 477960}, {t: 1587691115791, v: 478261}, {t: 1587691130791, v: 478559}, {t: 1587691145791, v: 478704},
		{t: 1587691160804, v: 478950}, {t: 1587691175791, v: 479173}, {t: 1587691190791, v: 479368}, {t: 1587691205791, v: 479625}, {t: 1587691220805, v: 479866}, {t: 1587691235791, v: 480008}, {t: 1587691250791, v: 480155}, {t: 1587691265791, v: 480472}, {t: 1587691280811, v: 480598}, {t: 1587691295791, v: 480771}, {t: 1587691310791, v: 480996},
		{t: 1587691325791, v: 481200}, {t: 1587691340803, v: 481381}, {t: 1587691355791, v: 481584}, {t: 1587691370791, v: 481759}, {t: 1587691385791, v: 482003}, {t: 1587691400803, v: 482189}, {t: 1587691415791, v: 482457}, {t: 1587691430791, v: 482623}, {t: 1587691445791, v: 482768}, {t: 1587691460804, v: 483036}, {t: 1587691475791, v: 483322},
		{t: 1587691490791, v: 483566}, {t: 1587691505791, v: 483709}, {t: 1587691520807, v: 483838}, {t: 1587691535791, v: 484091}, {t: 1587691550791, v: 484236}, {t: 1587691565791, v: 484454}, {t: 1587691580816, v: 484710}, {t: 1587691595791, v: 484978}, {t: 1587691610791, v: 485271}, {t: 1587691625791, v: 485476}, {t: 1587691640792, v: 485640},
		{t: 1587691655791, v: 485921}, {t: 1587691670791, v: 486201}, {t: 1587691685791, v: 486555}, {t: 1587691700791, v: 486691}, {t: 1587691715791, v: 486831}, {t: 1587691730791, v: 487033}, {t: 1587691745791, v: 487268}, {t: 1587691760803, v: 487370}, {t: 1587691775791, v: 487571}, {t: 1587691790791, v: 487787}, {t: 1587691805791, v: 488036},
		{t: 1587691820791, v: 488241}, {t: 1587691835791, v: 488411}, {t: 1587691850791, v: 488625}, {t: 1587691865791, v: 488868}, {t: 1587691880791, v: 489005}, {t: 1587691895791, v: 489237}, {t: 1587691910791, v: 489545}, {t: 1587691925791, v: 489750}, {t: 1587691940791, v: 489899}, {t: 1587691955791, v: 490048}, {t: 1587691970791, v: 490364},
		{t: 1587691985791, v: 490485}, {t: 1587692000791, v: 490722}, {t: 1587692015791, v: 490866}, {t: 1587692030791, v: 491025}, {t: 1587692045791, v: 491286}, {t: 1587692060816, v: 491543}, {t: 1587692075791, v: 491787}, {t: 1587692090791, v: 492065}, {t: 1587692105791, v: 492223}, {t: 1587692120816, v: 492501}, {t: 1587692135791, v: 492767},
		{t: 1587692150791, v: 492955}, {t: 1587692165791, v: 493194}, {t: 1587692180792, v: 493402}, {t: 1587692195791, v: 493647}, {t: 1587692210791, v: 493897}, {t: 1587692225791, v: 494117}, {t: 1587692240805, v: 494356}, {t: 1587692255791, v: 494620}, {t: 1587692270791, v: 494762}, {t: 1587692285791, v: 495001}, {t: 1587692300805, v: 495222},
		{t: 1587692315791, v: 495393}, {t: 1587692330791, v: 495662}, {t: 1587692345791, v: 495875}, {t: 1587692360801, v: 496082}, {t: 1587692375791, v: 496196}, {t: 1587692390791, v: 496245}, {t: 1587692405791, v: 496295}, {t: 1587692420791, v: 496365}, {t: 1587692435791, v: 496401}, {t: 1587692450791, v: 496452}, {t: 1587692465791, v: 496491},
		{t: 1587692480791, v: 496544}, {t: 1587692495791, v: math.Float64frombits(value.StaleNaN)}, {t: 1587692542149, v: 5}, {t: 1587692557139, v: 101}, {t: 1587692572139, v: 312}, {t: 1587692587139, v: 508}, {t: 1587692602144, v: 725}, {t: 1587692617139, v: 990}, {t: 1587692632139, v: 1178}, {t: 1587692647139, v: 1406}, {t: 1587692662154, v: 1640}, {t: 1587692677139, v: 1927},
		{t: 1587692692139, v: 2103}, {t: 1587692707139, v: 2300}, {t: 1587692722139, v: 2482}, {t: 1587692737139, v: 2638}, {t: 1587692752139, v: 2806}, {t: 1587692767139, v: 2979}, {t: 1587692782149, v: 3187}, {t: 1587692797139, v: 3441}, {t: 1587692812139, v: 3657}, {t: 1587692827139, v: 3827}, {t: 1587692842139, v: 3985}, {t: 1587692857139, v: 4195},
		{t: 1587692872139, v: 4427}, {t: 1587692887139, v: 4646}, {t: 1587692902139, v: 4714}, {t: 1587692917153, v: 4872}, {t: 1587692932139, v: 5131}, {t: 1587692947139, v: 5318}, {t: 1587692962139, v: 5571}, {t: 1587692977155, v: 5748}, {t: 1587692992139, v: 6030}, {t: 1587693007139, v: 6210}, {t: 1587693022139, v: 6399}, {t: 1587693037139, v: 6658},
		{t: 1587693052139, v: 6896}, {t: 1587693067139, v: 7098}, {t: 1587693082139, v: 7341}, {t: 1587693097139, v: 7495}, {t: 1587693112139, v: 7647}, {t: 1587693127139, v: 7830}, {t: 1587693142139, v: 8058}, {t: 1587693157139, v: 8209}, {t: 1587693172139, v: 8524}, {t: 1587693187139, v: 8712}, {t: 1587693202139, v: 8904}, {t: 1587693217139, v: 9103},
		{t: 1587693232139, v: 9404}, {t: 1587693247155, v: 9556}, {t: 1587693262139, v: 9777}, {t: 1587693277139, v: 9992}, {t: 1587693292139, v: 10268}, {t: 1587693307139, v: 10478}, {t: 1587693322139, v: 10754}, {t: 1587693337139, v: 10998}, {t: 1587693352139, v: 11249}, {t: 1587693367139, v: 11459}, {t: 1587693382139, v: 11778}, {t: 1587693397139, v: 12038},
		{t: 1587693412139, v: 12238}, {t: 1587693427139, v: 12450}, {t: 1587693442163, v: 12742}, {t: 1587693457139, v: 12945}, {t: 1587693472139, v: 13181}, {t: 1587693487139, v: 13440}, {t: 1587693502139, v: 13650}, {t: 1587693517139, v: 13966}, {t: 1587693532139, v: 14122}, {t: 1587693547139, v: 14327}, {t: 1587693562139, v: 14592},
		{t: 1587693577139, v: 14782}, {t: 1587693592139, v: 14956},
	}
)

func TestQuerier_Select(t *testing.T) {
	logger := log.NewLogfmtLogger(os.Stderr)

	type series struct {
		lset    labels.Labels
		samples []sample
	}

	for _, tcase := range []struct {
		name     string
		storeAPI storepb.StoreServer

		// Select test.
		mint, maxt      int64
		matchers        []*labels.Matcher
		replicaLabels   []string
		dedup           bool
		hints           *storage.SelectParams
		expected        []series
		expectedWarning string
	}{
		{
			name: "select overlapping data with partial error",
			storeAPI: &storeServer{
				resps: []*storepb.SeriesResponse{
					storeSeriesResponse(t, labels.FromStrings("a", "a"), []sample{{0, 0}, {2, 1}, {3, 2}}),
					storepb.NewWarnSeriesResponse(errors.New("partial error")),
					storeSeriesResponse(t, labels.FromStrings("a", "a"), []sample{{5, 5}, {6, 6}, {7, 7}}),
					storeSeriesResponse(t, labels.FromStrings("a", "a"), []sample{{5, 5}, {6, 66}}), // Overlap samples for some reason.
					storeSeriesResponse(t, labels.FromStrings("a", "b"), []sample{{2, 2}, {3, 3}, {4, 4}}, []sample{{1, 1}, {2, 2}, {3, 3}}),
					storeSeriesResponse(t, labels.FromStrings("a", "c"), []sample{{100, 1}, {300, 3}, {400, 4}}),
				},
			},
			mint: 1, maxt: 300,
			expected: []series{
				{
					lset:    labels.FromStrings("a", "a"),
					samples: []sample{{2, 1}, {3, 2}, {5, 5}, {6, 6}, {7, 7}},
				},
				{
					lset:    labels.FromStrings("a", "b"),
					samples: []sample{{1, 1}, {2, 2}, {3, 3}, {4, 4}},
				},
				{
					lset:    labels.FromStrings("a", "c"),
					samples: []sample{{100, 1}, {300, 3}},
				},
			},
			expectedWarning: "partial error",
		},
		{
			name: "select overlapping data with partial error + dedup",
			storeAPI: &storeServer{
				resps: []*storepb.SeriesResponse{
					storeSeriesResponse(t, labels.FromStrings("a", "a"), []sample{{0, 0}, {2, 1}, {3, 2}}),
					storepb.NewWarnSeriesResponse(errors.New("partial error")),
					storeSeriesResponse(t, labels.FromStrings("a", "a"), []sample{{5, 5}, {6, 6}, {7, 7}}),
					storeSeriesResponse(t, labels.FromStrings("a", "a"), []sample{{5, 5}, {6, 66}}), // Overlap samples for some reason.
					storeSeriesResponse(t, labels.FromStrings("a", "b"), []sample{{2, 2}, {3, 3}, {4, 4}}, []sample{{1, 1}, {2, 2}, {3, 3}}),
					storeSeriesResponse(t, labels.FromStrings("a", "c"), []sample{{100, 1}, {300, 3}, {400, 4}}),
				},
			},
			replicaLabels: []string{"a"},
			dedup:         true,
			mint:          1, maxt: 300,
			expected: []series{
				{
					lset: labels.Labels{},
					// TODO(bwplotka): This seems wrong.
					samples: []sample{{1, 1}, {2, 2}, {3, 3}, {4, 4}},
				},
			},
			expectedWarning: "partial error",
		},
		{
			name: "realistic data",
			storeAPI: func() storepb.StoreServer {
				s, err := store.NewLocalStoreFromJSONMmappableFile(logger, component.Debug, nil, "./testdata/issue2401-seriesresponses.json", store.ScanGRPCCurlProtoStreamMessages)
				testutil.Ok(t, err)
				return s
			}(),
			mint: 1582329611249,
			maxt: 1582331381245,
			matchers: []*labels.Matcher{{
				Value: "gitlab_transaction_cache_read_hit_count_total",
				Name:  "__name__",
				Type:  labels.MatchEqual,
			}},
			expected: []series{
				{
					lset: labels.FromStrings(
						"__name__", "gitlab_transaction_cache_read_hit_count_total",
						"action", "widget.json",
						"controller", "Projects::MergeRequests::ContentController",
						"env", "gprd",
						"environment", "gprd",
						"fqdn", "web-16-sv-gprd.c.gitlab-production.internal",
						"instance", "web-16-sv-gprd.c.gitlab-production.internal:8083",
						"job", "gitlab-rails",
						"monitor", "app",
						"provider", "gcp",
						"region", "us-east",
						"replica", "01",
						"shard", "default",
						"stage", "main",
						"tier", "sv",
						"type", "web",
					),
					samples: expectedRealSeriesReplica0,
				},
				{
					lset: labels.FromStrings(
						"__name__", "gitlab_transaction_cache_read_hit_count_total",
						"action", "widget.json",
						"controller", "Projects::MergeRequests::ContentController",
						"env", "gprd",
						"environment", "gprd",
						"fqdn", "web-16-sv-gprd.c.gitlab-production.internal",
						"instance", "web-16-sv-gprd.c.gitlab-production.internal:8083",
						"job", "gitlab-rails",
						"monitor", "app",
						"provider", "gcp",
						"region", "us-east",
						"replica", "02",
						"shard", "default",
						"stage", "main",
						"tier", "sv",
						"type", "web",
					),
					samples: expectedRealSeriesReplica1,
				},
			},
		},
		{
			name: "realistic data with stale marker",
			storeAPI: func() storepb.StoreServer {
				s, err := store.NewLocalStoreFromJSONMmappableFile(logger, component.Debug, nil, "./testdata/issue2401-seriesresponses2.json", store.ScanGRPCCurlProtoStreamMessages)
				testutil.Ok(t, err)
				return s
			}(),
			mint: 1587690000000, // 04/24/2020 01:00:00 GMT
			maxt: 1587693600000, // 04/24/2020 02:00:00 GMT
			matchers: []*labels.Matcher{{
				Value: "gitlab_transaction_cache_read_hit_count_total",
				Name:  "__name__",
				Type:  labels.MatchEqual,
			}},
			expected: []series{
				{
					lset: labels.FromStrings(
						"__name__", "gitlab_transaction_cache_read_hit_count_total",
						"action", "widget.json",
						"controller", "Projects::MergeRequests::ContentController",
						"env", "gprd",
						"environment", "gprd",
						"fqdn", "web-08-sv-gprd.c.gitlab-production.internal",
						"instance", "web-08-sv-gprd.c.gitlab-production.internal:8083",
						"job", "gitlab-rails",
						"monitor", "app",
						"provider", "gcp",
						"region", "us-east",
						"replica", "01",
						"shard", "default",
						"stage", "main",
						"tier", "sv",
						"type", "web",
					),
					samples: expectedRealSeriesWithStaleMarkerReplica0,
				},
				{
					lset: labels.FromStrings(
						"__name__", "gitlab_transaction_cache_read_hit_count_total",
						"action", "widget.json",
						"controller", "Projects::MergeRequests::ContentController",
						"env", "gprd",
						"environment", "gprd",
						"fqdn", "web-08-sv-gprd.c.gitlab-production.internal",
						"instance", "web-08-sv-gprd.c.gitlab-production.internal:8083",
						"job", "gitlab-rails",
						"monitor", "app",
						"provider", "gcp",
						"region", "us-east",
						"replica", "02",
						"shard", "default",
						"stage", "main",
						"tier", "sv",
						"type", "web",
					),
					samples: expectedRealSeriesWithStaleMarkerReplica1,
				},
			},
		},
		{
			// Regression test against https://github.com/thanos-io/thanos/issues/2401.
			// Thanks to @Superq and GitLab for real data reproducing this!
			name: "realistic data with stale marker + dedup",
			storeAPI: func() storepb.StoreServer {
				s, err := store.NewLocalStoreFromJSONMmappableFile(logger, component.Debug, nil, "./testdata/issue2401-seriesresponses2.json", store.ScanGRPCCurlProtoStreamMessages)
				testutil.Ok(t, err)
				return s
			}(),
			replicaLabels: []string{"replica"},
			dedup:         true,
			mint:          1587690000000, // 04/24/2020 01:00:00 GMT
			maxt:          1587693600000, // 04/24/2020 02:00:00 GMT
			matchers: []*labels.Matcher{{
				Value: "gitlab_transaction_cache_read_hit_count_total",
				Name:  "__name__",
				Type:  labels.MatchEqual,
			}},
			expected: []series{
				{
					lset: labels.FromStrings(
						"__name__", "gitlab_transaction_cache_read_hit_count_total",
						"action", "widget.json",
						"controller", "Projects::MergeRequests::ContentController",
						"env", "gprd",
						"environment", "gprd",
						"fqdn", "web-08-sv-gprd.c.gitlab-production.internal",
						"instance", "web-08-sv-gprd.c.gitlab-production.internal:8083",
						"job", "gitlab-rails",
						"monitor", "app",
						"provider", "gcp",
						"region", "us-east",
						"shard", "default",
						"stage", "main",
						"tier", "sv",
						"type", "web",
					),
					samples: expectedRealSeriesWithStaleMarkerDeduplicated,
				},
			},
		},
	} {
		t.Run(tcase.name, func(t *testing.T) {
			defer leaktest.CheckTimeout(t, 10*time.Second)()

			q := newQuerier(context.Background(), nil, tcase.mint, tcase.maxt, tcase.replicaLabels, tcase.storeAPI, tcase.dedup, 0, true, false)
			defer func() { testutil.Ok(t, q.Close()) }()

			res, w, err := q.Select(tcase.hints, tcase.matchers...)
			testutil.Ok(t, err)
			if tcase.expectedWarning != "" {
				testutil.Equals(t, 1, len(w))
				testutil.Equals(t, tcase.expectedWarning, w[0].Error())
			}

			i := 0
			for res.Next() {
				testutil.Assert(t, i < len(tcase.expected), "more series than expected")
				testutil.Equals(t, tcase.expected[i].lset, res.At().Labels())

				samples := expandSeries(t, res.At().Iterator())
				expected := make([]sample, 0, len(tcase.expected[i].samples))
				for _, s := range tcase.expected[i].samples {
					v := s.v
					if value.IsStaleNaN(v) {
						// Nan != Nan, so substitute for another value.
						v = hackyStaleMarker
					}
					expected = append(expected, sample{t: s.t, v: v})
				}
				testutil.Equals(t, expected, samples, "samples for series %v does not match", i)
				i++
			}
			testutil.Ok(t, res.Err())
			testutil.Equals(t, len(tcase.expected), i)
		})
	}
}

type mockedOneSeriesSeriesSet struct {
	done    bool
	samples []sample
}

func (s *mockedOneSeriesSeriesSet) Next() bool {
	if !s.done {
		s.done = true
		return true
	}
	return false
}

func (s *mockedOneSeriesSeriesSet) At() storage.Series { return &mockedSeries{samples: s.samples} }
func (s *mockedOneSeriesSeriesSet) Err() error         { return nil }

type mockedSeries struct {
	samples []sample
}

func (s *mockedSeries) Labels() labels.Labels { return labels.FromStrings("a", "b") }
func (s *mockedSeries) Iterator() storage.SeriesIterator {
	return &mockedSeriesIterator{cur: -1, samples: s.samples}
}

type mockedSeriesIterator struct {
	cur     int
	samples []sample
}

func (s *mockedSeriesIterator) Seek(t int64) bool {
	s.cur = sort.Search(len(s.samples), func(n int) bool {
		return s.samples[n].t >= t
	})
	return s.cur < len(s.samples)
}

func (s *mockedSeriesIterator) At() (t int64, v float64) {
	sample := s.samples[s.cur]
	return sample.t, sample.v
}

func (s *mockedSeriesIterator) Next() bool {
	s.cur++
	return s.cur < len(s.samples)
}

func (s *mockedSeriesIterator) Err() error { return nil }

type mockedQueryable struct {
	samples []sample
}

func (q *mockedQueryable) Querier(context.Context, int64, int64) (storage.Querier, error) {
	return q, nil
}

func (q *mockedQueryable) Select(_ *storage.SelectParams, _ ...*labels.Matcher) (storage.SeriesSet, storage.Warnings, error) {
	return &mockedOneSeriesSeriesSet{samples: q.samples}, nil, nil
}

func (q mockedQueryable) LabelValues(string) ([]string, storage.Warnings, error) {
	panic("implement me")
}
func (q mockedQueryable) LabelNames() ([]string, storage.Warnings, error) { panic("implement me") }
func (q mockedQueryable) Close() error                                    { return nil }

func TestQuerierUnderstoodByPromQL_Rate(t *testing.T) {
	logger := log.NewLogfmtLogger(os.Stderr)

	for _, tcase := range []struct {
		name       string
		input      []sample
		mint, maxt time.Time

		expectedRate5m  []sample
		expectedRate30m []sample
	}{
		{
			name:  "realistic data",
			mint:  timestamp.Time(1582329611249),
			maxt:  timestamp.Time(1582331381245),
			input: expectedRealSeriesReplica0,
		},
		{
			name:  "realistic data with stale marker",
			mint:  timestamp.Time(1587690000000), // 04/24/2020 01:00:00 GMT
			maxt:  timestamp.Time(1587693600000), // 04/24/2020 02:00:00 GMT
			input: expectedRealSeriesWithStaleMarkerReplica0,
		},
		{
			// Regression test against  https://github.com/thanos-io/thanos/issues/2401.
			name:  "deduplicated realistic data with stale marker",
			mint:  timestamp.Time(1587690000000), // 04/24/2020 01:00:00 GMT
			maxt:  timestamp.Time(1587693600000), // 04/24/2020 02:00:00 GMT
			input: expectedRealSeriesWithStaleMarkerDeduplicated,
		},
	} {
		t.Run(tcase.name, func(t *testing.T) {
			e := promql.NewEngine(promql.EngineOpts{
				Logger:        logger,
				MaxConcurrent: 1,
				Timeout:       5 * time.Second,
				MaxSamples:    math.MaxInt64,
			})
			t.Run("Rate=5mStep=500s", func(t *testing.T) {
				q, err := e.NewRangeQuery(&mockedQueryable{samples: tcase.input}, `rate({a="b"}[5m])`, tcase.mint.Add(5*time.Minute), tcase.maxt, 500*time.Second)
				testutil.Ok(t, err)
				defer q.Close()

				r := q.Exec(context.Background())
				testutil.Ok(t, r.Err)
				testutil.Assert(t, len(r.Warnings) == 0)

				fmt.Println(r.String())
			})
			t.Run("Rate=30mStep=500s", func(t *testing.T) {
				q, err := e.NewRangeQuery(&mockedQueryable{samples: tcase.input}, `rate({a="b"}[30m])`, tcase.mint.Add(30*time.Minute), tcase.maxt, 500*time.Second)
				testutil.Ok(t, err)
				defer q.Close()

				r := q.Exec(context.Background())
				testutil.Ok(t, r.Err)
				testutil.Assert(t, len(r.Warnings) == 0)

				fmt.Println(r.String())
			})
		})
	}
}
func TestSortReplicaLabel(t *testing.T) {
	defer leaktest.CheckTimeout(t, 10*time.Second)()

	tests := []struct {
		input       []storepb.Series
		exp         []storepb.Series
		dedupLabels map[string]struct{}
	}{
		// 0 Single deduplication label.
		{
			input: []storepb.Series{
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-1"},
					{Name: "c", Value: "3"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-1"},
					{Name: "c", Value: "3"},
					{Name: "d", Value: "4"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-1"},
					{Name: "c", Value: "4"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-2"},
					{Name: "c", Value: "3"},
				}},
			},
			exp: []storepb.Series{
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "3"},
					{Name: "b", Value: "replica-1"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "3"},
					{Name: "b", Value: "replica-2"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "3"},
					{Name: "d", Value: "4"},
					{Name: "b", Value: "replica-1"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "4"},
					{Name: "b", Value: "replica-1"},
				}},
			},
			dedupLabels: map[string]struct{}{"b": {}},
		},
		// 1 Multi deduplication labels.
		{
			input: []storepb.Series{
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-1"},
					{Name: "b1", Value: "replica-1"},
					{Name: "c", Value: "3"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-1"},
					{Name: "b1", Value: "replica-1"},
					{Name: "c", Value: "3"},
					{Name: "d", Value: "4"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-1"},
					{Name: "b1", Value: "replica-1"},
					{Name: "c", Value: "4"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-2"},
					{Name: "b1", Value: "replica-2"},
					{Name: "c", Value: "3"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "b", Value: "replica-2"},
					{Name: "c", Value: "3"},
				}},
			},
			exp: []storepb.Series{
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "3"},
					{Name: "b", Value: "replica-1"},
					{Name: "b1", Value: "replica-1"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "3"},
					{Name: "b", Value: "replica-2"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "3"},
					{Name: "b", Value: "replica-2"},
					{Name: "b1", Value: "replica-2"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "3"},
					{Name: "d", Value: "4"},
					{Name: "b", Value: "replica-1"},
					{Name: "b1", Value: "replica-1"},
				}},
				{Labels: []storepb.Label{
					{Name: "a", Value: "1"},
					{Name: "c", Value: "4"},
					{Name: "b", Value: "replica-1"},
					{Name: "b1", Value: "replica-1"},
				}},
			},
			dedupLabels: map[string]struct{}{
				"b":  {},
				"b1": {},
			},
		},
	}
	for _, test := range tests {
		t.Run("", func(t *testing.T) {
			sortDedupLabels(test.input, test.dedupLabels)
			testutil.Equals(t, test.exp, test.input)
		})
	}
}

const hackyStaleMarker = float64(-99999999)

func expandSeries(t testing.TB, it storage.SeriesIterator) (res []sample) {
	for it.Next() {
		t, v := it.At()
		// Nan != Nan, so substitute for another value.
		if math.IsNaN(v) {
			v = hackyStaleMarker
		}
		res = append(res, sample{t, v})
	}
	testutil.Ok(t, it.Err())
	return res
}

func TestDedupSeriesSet(t *testing.T) {
	defer leaktest.CheckTimeout(t, 10*time.Second)()

	tests := []struct {
		input []struct {
			lset []storepb.Label
			vals []sample
		}
		exp []struct {
			lset labels.Labels
			vals []sample
		}
		dedupLabels map[string]struct{}
	}{
		{ // 0 Single dedup label.
			input: []struct {
				lset []storepb.Label
				vals []sample
			}{
				{
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-1"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-2"}},
					vals: []sample{{60000, 3}, {70000, 4}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-3"}},
					vals: []sample{{200000, 5}, {210000, 6}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "d", Value: "4"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "4"}, {Name: "replica", Value: "replica-1"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "2"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-3"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "2"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-3"}},
					vals: []sample{{60000, 3}, {70000, 4}},
				},
			},
			exp: []struct {
				lset labels.Labels
				vals []sample
			}{
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}, {60000, 3}, {70000, 4}, {200000, 5}, {210000, 6}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "d", Value: "4"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "4"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "2"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}, {60000, 3}, {70000, 4}},
				},
			},
			dedupLabels: map[string]struct{}{
				"replica": {},
			},
		},
		{ // 1 Multi dedup label.
			input: []struct {
				lset []storepb.Label
				vals []sample
			}{
				{
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-1"}, {Name: "replicaA", Value: "replica-1"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-2"}, {Name: "replicaA", Value: "replica-2"}},
					vals: []sample{{60000, 3}, {70000, 4}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-3"}, {Name: "replicaA", Value: "replica-3"}},
					vals: []sample{{200000, 5}, {210000, 6}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "d", Value: "4"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "4"}, {Name: "replica", Value: "replica-1"}, {Name: "replicaA", Value: "replica-1"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "2"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-3"}, {Name: "replicaA", Value: "replica-3"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "2"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-3"}, {Name: "replicaA", Value: "replica-3"}},
					vals: []sample{{60000, 3}, {70000, 4}},
				},
			},
			exp: []struct {
				lset labels.Labels
				vals []sample
			}{
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}, {60000, 3}, {70000, 4}, {200000, 5}, {210000, 6}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "d", Value: "4"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "4"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				},
				{
					lset: labels.Labels{{Name: "a", Value: "2"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}, {60000, 3}, {70000, 4}},
				},
			},
			dedupLabels: map[string]struct{}{
				"replica":  {},
				"replicaA": {},
			},
		},
		{ // 2 Multi dedup label - some series don't have all dedup labels.
			input: []struct {
				lset []storepb.Label
				vals []sample
			}{
				{
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-1"}, {Name: "replicaA", Value: "replica-1"}},
					vals: []sample{{10000, 1}, {20000, 2}},
				}, {
					lset: []storepb.Label{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}, {Name: "replica", Value: "replica-2"}},
					vals: []sample{{60000, 3}, {70000, 4}},
				},
			},
			exp: []struct {
				lset labels.Labels
				vals []sample
			}{
				{
					lset: labels.Labels{{Name: "a", Value: "1"}, {Name: "c", Value: "3"}},
					vals: []sample{{10000, 1}, {20000, 2}, {60000, 3}, {70000, 4}},
				},
			},
			dedupLabels: map[string]struct{}{
				"replica":  {},
				"replicaA": {},
			},
		},
	}

	for _, test := range tests {
		t.Run("", func(t *testing.T) {
			var series []storepb.Series
			for _, c := range test.input {
				chk := chunkenc.NewXORChunk()
				app, _ := chk.Appender()
				for _, s := range c.vals {
					app.Append(s.t, s.v)
				}
				series = append(series, storepb.Series{
					Labels: c.lset,
					Chunks: []storepb.AggrChunk{
						{Raw: &storepb.Chunk{Type: storepb.Chunk_XOR, Data: chk.Bytes()}},
					},
				})
			}
			set := &promSeriesSet{
				mint: 1,
				maxt: math.MaxInt64,
				set:  newStoreSeriesSet(series),
			}
			dedupSet := newDedupSeriesSet(set, test.dedupLabels)

			i := 0
			for dedupSet.Next() {
				testutil.Equals(t, test.exp[i].lset, dedupSet.At().Labels(), "labels mismatch at index:%v", i)
				res := expandSeries(t, dedupSet.At().Iterator())
				testutil.Equals(t, test.exp[i].vals, res, "values mismatch at index:%v", i)
				i++
			}
			testutil.Ok(t, dedupSet.Err())
		})
	}
}

func TestDedupSeriesIterator(t *testing.T) {
	defer leaktest.CheckTimeout(t, 10*time.Second)()

	// The deltas between timestamps should be at least 10000 to not be affected
	// by the initial penalty of 5000, that will cause the second iterator to seek
	// ahead this far at least once.
	cases := []struct {
		a, b, exp []sample
	}{
		{ // Generally prefer the first series.
			a:   []sample{{10000, 10}, {20000, 11}, {30000, 12}, {40000, 13}},
			b:   []sample{{10000, 20}, {20000, 21}, {30000, 22}, {40000, 23}},
			exp: []sample{{10000, 10}, {20000, 11}, {30000, 12}, {40000, 13}},
		},
		{ // Prefer b if it starts earlier.
			a:   []sample{{10100, 1}, {20100, 1}, {30100, 1}, {40100, 1}},
			b:   []sample{{10000, 2}, {20000, 2}, {30000, 2}, {40000, 2}},
			exp: []sample{{10000, 2}, {20000, 2}, {30000, 2}, {40000, 2}},
		},
		{ // Don't switch series on a single delta sized gap.
			a:   []sample{{10000, 1}, {20000, 1}, {40000, 1}},
			b:   []sample{{10000, 2}, {20000, 2}, {30000, 2}, {40000, 2}},
			exp: []sample{{10000, 1}, {20000, 1}, {40000, 1}},
		},
		{
			a:   []sample{{10000, 1}, {20000, 1}, {40000, 1}},
			b:   []sample{{15000, 2}, {25000, 2}, {35000, 2}, {45000, 2}},
			exp: []sample{{10000, 1}, {20000, 1}, {40000, 1}},
		},
		{ // Once the gap gets bigger than 2 deltas, switch and stay with the new series.
			a:   []sample{{10000, 1}, {20000, 1}, {30000, 1}, {60000, 1}, {70000, 1}},
			b:   []sample{{10100, 2}, {20100, 2}, {30100, 2}, {40100, 2}, {50100, 2}, {60100, 2}},
			exp: []sample{{10000, 1}, {20000, 1}, {30000, 1}, {50100, 2}, {60100, 2}},
		},
	}
	for i, c := range cases {
		t.Logf("case %d:", i)
		it := newDedupSeriesIterator(
			&SampleIterator{l: c.a, i: -1},
			&SampleIterator{l: c.b, i: -1},
		)
		res := expandSeries(t, it)
		testutil.Equals(t, c.exp, res)
	}
}

func BenchmarkDedupSeriesIterator(b *testing.B) {
	run := func(b *testing.B, s1, s2 []sample) {
		it := newDedupSeriesIterator(
			&SampleIterator{l: s1, i: -1},
			&SampleIterator{l: s2, i: -1},
		)
		b.ResetTimer()
		var total int64

		for it.Next() {
			t, _ := it.At()
			total += t
		}
		fmt.Fprint(ioutil.Discard, total)
	}
	b.Run("equal", func(b *testing.B) {
		var s1, s2 []sample

		for i := 0; i < b.N; i++ {
			s1 = append(s1, sample{t: int64(i * 10000), v: 1})
		}
		for i := 0; i < b.N; i++ {
			s2 = append(s2, sample{t: int64(i * 10000), v: 2})
		}
		run(b, s1, s2)
	})
	b.Run("fixed-delta", func(b *testing.B) {
		var s1, s2 []sample

		for i := 0; i < b.N; i++ {
			s1 = append(s1, sample{t: int64(i * 10000), v: 1})
		}
		for i := 0; i < b.N; i++ {
			s2 = append(s2, sample{t: int64(i*10000) + 10, v: 2})
		}
		run(b, s1, s2)
	})
	b.Run("minor-rand-delta", func(b *testing.B) {
		var s1, s2 []sample

		for i := 0; i < b.N; i++ {
			s1 = append(s1, sample{t: int64(i*10000) + rand.Int63n(5000), v: 1})
		}
		for i := 0; i < b.N; i++ {
			s2 = append(s2, sample{t: int64(i*10000) + +rand.Int63n(5000), v: 2})
		}
		run(b, s1, s2)
	})
}

type sample struct {
	t int64
	v float64
}

type SampleIterator struct {
	l []sample
	i int
}

func (s *SampleIterator) Err() error {
	return nil
}

func (s *SampleIterator) At() (int64, float64) {
	return s.l[s.i].t, s.l[s.i].v
}

func (s *SampleIterator) Next() bool {
	if s.i >= len(s.l) {
		return false
	}
	s.i++
	return true
}

func (s *SampleIterator) Seek(t int64) bool {
	if s.i < 0 {
		s.i = 0
	}
	for {
		if s.i >= len(s.l) {
			return false
		}
		if s.l[s.i].t >= t {
			return true
		}
		s.i++
	}
}

type storeServer struct {
	// This field just exist to pseudo-implement the unused methods of the interface.
	storepb.StoreServer

	resps []*storepb.SeriesResponse
}

func (s *storeServer) Series(r *storepb.SeriesRequest, srv storepb.Store_SeriesServer) error {
	for _, resp := range s.resps {
		err := srv.Send(resp)
		if err != nil {
			return err
		}
	}
	return nil
}

// storeSeriesResponse creates test storepb.SeriesResponse that includes series with single chunk that stores all the given samples.
func storeSeriesResponse(t testing.TB, lset labels.Labels, smplChunks ...[]sample) *storepb.SeriesResponse {
	var s storepb.Series

	for _, l := range lset {
		s.Labels = append(s.Labels, storepb.Label{Name: l.Name, Value: l.Value})
	}

	for _, smpls := range smplChunks {
		c := chunkenc.NewXORChunk()
		a, err := c.Appender()
		testutil.Ok(t, err)

		for _, smpl := range smpls {
			a.Append(smpl.t, smpl.v)
		}

		ch := storepb.AggrChunk{
			MinTime: smpls[0].t,
			MaxTime: smpls[len(smpls)-1].t,
			Raw:     &storepb.Chunk{Type: storepb.Chunk_XOR, Data: c.Bytes()},
		}

		s.Chunks = append(s.Chunks, ch)
	}
	return storepb.NewSeriesResponse(&s)
}
